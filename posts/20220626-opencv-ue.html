<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Use OpenCV in Unreal Engine</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="https://gongzhitaao.org/orgcss/org.css"/>
<link rel="stylesheet" type="text/css" href="/orgstyle.css"/>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fira+Mono:wght@400;700&amp;display=swap" rel="stylesheet">
<link rel="icon" href="spock-favicon.png" type="image/png">
</head>
<body>
<div id="preamble" class="status">
<hr style="border-top: 1px solid black;">
<div class='topnav' style='display: flex; justify-content: space-between; align-items: center;'>
  <a href="/index.html"><h2 style='margin-top: 0; margin-bottom: 0; margin-left:0px;'>Lafith Mattara</h2></a>
  <div class='topnav2' style='color:#cfcaca;'>
   / <a href='/blog.html' style='font-weight:bold; font-style:bold;'>All Posts</a> / 
  </div>
</div>
<hr style="border-top: 1px solid black;">
</div>
<div id="content" class="content">
<header>
<h1 class="title">Use OpenCV in Unreal Engine</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgc5ec3e3">UE5</a></li>
<li><a href="#org8aa3521">UE4</a></li>
</ul>
</div>
</nav>
<p>
OpenCV is widely used to read, process, analyse and modify images and videos, while Unreal engine
is an extremely powerful game engine. By using OpenCV in Unreal engine one can create interesting applications.
Integration of OpenCV is different between UE4 and UE5 as UE5 released a standalone plugin for OpenCV in beta.
</p>

<div id="outline-container-orgc5ec3e3" class="outline-2">
<h2 id="orgc5ec3e3">UE5</h2>
<div class="outline-text-2" id="text-orgc5ec3e3">
<p>
After installing Unreal Engine 5 create a new C++ project. Open the project in the editor then go to <code>Edit-&gt;Plugins</code>.
Search for OpenCV and install it, you may have to restart the engine after that.
Edit your <code>build.cs</code> file to include the correct modules. This file would be present at <code>[ProjectName]/Source/[ProjectName].build.cs</code>.
</p>

<p>
Change the public and private dependencies in to the following:
</p>
<div class="org-src-container">
<pre class="src src-csharp">PublicDependencyModuleNames.<span class="org-function-name">AddRange</span>(
  <span class="org-keyword">new</span> <span class="org-type">string</span>[] {
    <span class="org-string">"Core"</span>,
    <span class="org-string">"CoreUObject"</span>,
    <span class="org-string">"Engine"</span>,
    <span class="org-string">"OpenCV"</span>,
    <span class="org-string">"OpenCVHelper"</span>,
    <span class="org-string">"InputCore"</span>
  });
PrivateDependencyModuleNames.<span class="org-function-name">AddRange</span>(
  <span class="org-keyword">new</span> <span class="org-type">string</span>[] {
    <span class="org-string">"Core"</span>,
    <span class="org-string">"CoreUObject"</span>,
    <span class="org-string">"Engine"</span>,
    <span class="org-string">"Renderer"</span>,
    <span class="org-string">"RenderCore"</span>,
    <span class="org-string">"RHI"</span>,
    <span class="org-string">"RHICore"</span>,
    <span class="org-string">"D3D12RHI"</span>,
    <span class="org-string">"OpenCV"</span>,
    <span class="org-string">"OpenCVHelper"</span>
    });
</pre>
</div>

<p>
Create a new C++ class and use following code for testing the integration:
</p>

<p>
<b>Header file</b>
</p>
<div class="org-src-container">
<pre class="src src-C++"><span class="org-preprocessor">#pragma</span> once
        
<span class="org-preprocessor">#include</span> <span class="org-string">"CoreMinimal.h"</span>
<span class="org-preprocessor">#include</span> <span class="org-string">"GameFramework/Actor.h"</span>

<span class="org-preprocessor">#include</span> <span class="org-string">"PreOpenCVHeaders.h"</span>
<span class="org-preprocessor">#include</span> <span class="org-string">"OpenCVHelper.h"</span>
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;ThirdParty/OpenCV/include/opencv2/imgproc.hpp&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;ThirdParty/OpenCV/include/opencv2/highgui/highgui.hpp&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;ThirdParty/OpenCV/include/opencv2/core.hpp&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string">"PostOpenCVHeaders.h"</span>
<span class="org-preprocessor">#include</span> <span class="org-string">"Log.h"</span>
<span class="org-preprocessor">#include</span> <span class="org-string">"MyActor.generated.h"</span>

UCLASS()
<span class="org-keyword">class</span> <span class="org-type">CVTESTCORE_API</span> <span class="org-type">AMyActor</span> : <span class="org-keyword">public</span> <span class="org-type">AActor</span>
{
    GENERATED_BODY()

<span class="org-keyword">public</span>: 
    <span class="org-comment-delimiter">// </span><span class="org-comment">Sets default values for this actor's properties</span>
    <span class="org-function-name">AMyActor</span>();
    <span class="org-type">void</span> <span class="org-function-name">TestOpenCV</span>();

<span class="org-keyword">protected</span>:
    <span class="org-comment-delimiter">// </span><span class="org-comment">Called when the game starts or when spawned</span>
    <span class="org-keyword">virtual</span> <span class="org-type">void</span> <span class="org-function-name">BeginPlay</span>() <span class="org-keyword">override</span>;

<span class="org-keyword">public</span>: 
    <span class="org-comment-delimiter">// </span><span class="org-comment">Called every frame</span>
    <span class="org-keyword">virtual</span> <span class="org-type">void</span> <span class="org-function-name">Tick</span>(<span class="org-type">float</span> <span class="org-variable-name">DeltaTime</span>) <span class="org-keyword">override</span>;

};
</pre>
</div>

<p>
<b>cpp file</b>
</p>
<div class="org-src-container">
<pre class="src src-C++"><span class="org-preprocessor">#include</span> <span class="org-string">"MyActor.h"</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Sets default values</span>
<span class="org-constant">AMyActor</span>::<span class="org-function-name">AMyActor</span>()
{
    <span class="org-comment-delimiter">// </span><span class="org-comment">Set this actor to call Tick() every frame.  You can turn this off to improve performance if you don't need it.</span>
PrimaryActorTick.bCanEverTick = <span class="org-constant">true</span>;

}

<span class="org-type">void</span> <span class="org-constant">AMyActor</span>::<span class="org-function-name">TestOpenCV</span>(){
UE_LOG(LogcvtestCore, Log, TEXT(<span class="org-string">"Testing OpenCV..."</span>));
<span class="org-type">int</span> <span class="org-variable-name">testDim</span>[3] = {2, 3, 4};
<span class="org-constant">cv</span>::<span class="org-type">Mat</span> <span class="org-variable-name">testMat</span>(3, testDim, CV_32FC1);
UE_LOG(
    LogcvtestCore, Log,
    TEXT(<span class="org-string">"dimension = %d, %d, %d"</span>),
    testMat.size[0], testMat.size[1], testMat.size[2]);
UE_LOG(LogcvtestCore, Log, TEXT(<span class="org-string">"Testing Done!"</span>));
}

<span class="org-comment-delimiter">// </span><span class="org-comment">Called when the game starts or when spawned</span>
<span class="org-type">void</span> <span class="org-constant">AMyActor</span>::<span class="org-function-name">BeginPlay</span>()
{
<span class="org-constant">Super</span>::BeginPlay();
TestOpenCV();

}

<span class="org-comment-delimiter">// </span><span class="org-comment">Called every frame</span>
<span class="org-type">void</span> <span class="org-constant">AMyActor</span>::<span class="org-function-name">Tick</span>(<span class="org-type">float</span> <span class="org-variable-name">DeltaTime</span>)
{
<span class="org-constant">Super</span>::Tick(DeltaTime);

}

</pre>
</div>

<p>
After compiling the newly created class add the actor in to your map, upon starting the level you should see a log output with the
dimensions of the cv::Mat object.
</p>
</div>
</div>

<div id="outline-container-org8aa3521" class="outline-2">
<h2 id="org8aa3521">UE4</h2>
<div class="outline-text-2" id="text-org8aa3521">
<p>
Incase of UE4 you need to manually include the binaries from OpenCV installation source in to your UE4 project.
</p>
<ul class="org-ul">
<li>Copy the <code>/build/include/opencv2</code> to the <code>[UE4ProjectDir]/ThirdParty/OpenCV/Includes</code>.</li>
<li>You will find <code>opencv_world460.dll</code> and <code>opencv_ffmpeg460_64.dll</code> inside the <code>/build/x64/vc14/bin</code>, copy them to <code>[UE4ProjectDir]/ThirdParty/OpenCV/Libraries/Win64</code>.</li>
<li>Copy <code>opencv_world460.lib</code> from <code>/build/x64/vc14/lib</code> to <code>/build/x64/vc14/lib</code> to <code>[UE4ProjectDir]/ThirdParty/OpenCV/Libraries/Win64</code>.</li>
<li>Also copy the files mentioned in above two steps into <code>[UE4ProjectDir]/Binaries/Win64</code></li>
</ul>

<p>
Link these files by editing the module rule file <code>[UE4ProjectDir]/Source/[Project Name].build.cs</code>
</p>
<div class="org-src-container">
<pre class="src src-csharp"><span class="org-keyword">using</span> <span class="org-variable-name">UnrealBuildTool</span>;
<span class="org-keyword">using</span> <span class="org-variable-name">System</span>.<span class="org-variable-name">IO</span>;

<span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">TestProjectCore</span> : <span class="org-type">ModuleRules</span>
{
<span class="org-type">string</span> <span class="org-variable-name">OPENCV_VERSION</span> = <span class="org-string">"460"</span>;
<span class="org-keyword">private</span> <span class="org-type">string</span> <span class="org-variable-name">ThirdPartyPath</span>
    {
    <span class="org-keyword">get</span>
        {
    <span class="org-keyword">return</span> Path.<span class="org-function-name">GetFullPath</span>(Path.<span class="org-function-name">Combine</span>(ModuleDirectory, <span class="org-string">"../../ThirdParty/"</span>));
        }
    }

<span class="org-keyword">public</span> <span class="org-type">bool</span> <span class="org-function-name">LoadOpenCV</span>(<span class="org-type">ReadOnlyTargetRules</span> <span class="org-variable-name">Target</span>)
    {
    <span class="org-type">bool</span> <span class="org-variable-name">isLibrarySupported</span> = <span class="org-constant">false</span>;
    <span class="org-type">string</span> <span class="org-variable-name">OpenCVPath</span> = Path.<span class="org-function-name">Combine</span>(ThirdPartyPath, <span class="org-string">"OpenCV"</span>);

    <span class="org-type">string</span> <span class="org-variable-name">LibPath</span> = <span class="org-string">""</span>;
    <span class="org-type">bool</span> <span class="org-variable-name">isdebug</span> = Target.Configuration == UnrealTargetConfiguration.Debug;
    <span class="org-keyword">if</span> (Target.Platform == UnrealTargetPlatform.Win64)
    {
    LibPath = Path.<span class="org-function-name">Combine</span>(OpenCVPath, <span class="org-string">"Libraries"</span>, <span class="org-string">"Win64"</span>);
    isLibrarySupported = <span class="org-constant">true</span>;
    }
    <span class="org-keyword">else</span>
    {
    <span class="org-type">string</span> <span class="org-variable-name">Err</span> = <span class="org-type">string</span>.<span class="org-function-name">Format</span>(
        <span class="org-string">"{0} dedicated server is made to depend on {1}. We want to avoid this, please correct module dependencies"</span>,
        Target.Platform.<span class="org-function-name">ToString</span>(), <span class="org-keyword">this</span>.<span class="org-function-name">ToString</span>());
    System.Console.<span class="org-function-name">WriteLine</span>(Err);
        }

    <span class="org-keyword">if</span> (isLibrarySupported)
        {
    PublicIncludePaths.<span class="org-function-name">AddRange</span>(<span class="org-keyword">new</span> <span class="org-type">string</span>[] { Path.<span class="org-function-name">Combine</span>(OpenCVPath, <span class="org-string">"Includes"</span>) });
    PublicAdditionalLibraries.<span class="org-function-name">Add</span>(Path.<span class="org-function-name">Combine</span>(LibPath, <span class="org-string">"opencv_world"</span> + OPENCV_VERSION + <span class="org-string">".lib"</span>));
    PublicDelayLoadDLLs.<span class="org-function-name">Add</span>(<span class="org-string">"opencv_world"</span> + OPENCV_VERSION + <span class="org-string">".dll"</span>);
    PublicDelayLoadDLLs.<span class="org-function-name">Add</span>(<span class="org-string">"opencv_videoio_ffmpeg"</span> + OPENCV_VERSION + <span class="org-string">"_64.dll"</span>);

        }

    PublicDefinitions.<span class="org-function-name">Add</span>(<span class="org-type">string</span>.<span class="org-function-name">Format</span>(<span class="org-string">"WITH_OPENCV_BINDING={0}"</span>, isLibrarySupported ? 1 : 0));
    <span class="org-keyword">return</span> isLibrarySupported;
    }

    <span class="org-keyword">private</span> <span class="org-type">string</span> <span class="org-variable-name">poject_root_path</span>
{
    <span class="org-keyword">get</span> { <span class="org-keyword">return</span> Path.<span class="org-function-name">Combine</span>(ModuleDirectory, <span class="org-string">"../.."</span>); }
}  

<span class="org-keyword">public</span> <span class="org-function-name">TestProjectCore</span>(ReadOnlyTargetRules Target) : <span class="org-keyword">base</span>(Target)
{
    PCHUsage = PCHUsageMode.UseExplicitOrSharedPCHs;
    bEnforceIWYU = <span class="org-constant">true</span>;

    PublicDependencyModuleNames.<span class="org-function-name">AddRange</span>(<span class="org-keyword">new</span> <span class="org-type">string</span>[] {
    <span class="org-string">"Core"</span>, <span class="org-string">"CoreUObject"</span>,
    <span class="org-string">"Engine"</span>, <span class="org-string">"InputCore"</span>
    });
    PublicDependencyModuleNames.<span class="org-function-name">AddRange</span>(<span class="org-keyword">new</span> <span class="org-type">string</span>[] {
    <span class="org-string">"RHI"</span>, <span class="org-string">"RenderCore"</span>,
    <span class="org-string">"Media"</span>, <span class="org-string">"MediaAssets"</span>
    });



    <span class="org-function-name">LoadOpenCV</span>(Target);


}
}
</pre>
</div>

<p>
In order to check the integration you can use the same Actor c++ scripts I used in the case of UE5, but this time the header files
would be different in the .h file.
</p>

<div class="org-src-container">
<pre class="src src-C++"><span class="org-preprocessor">#pragma</span> once

<span class="org-preprocessor">#include</span> <span class="org-string">"CoreMinimal.h"</span>
<span class="org-preprocessor">#include</span> <span class="org-string">"GameFramework/Actor.h"</span>
<span class="org-preprocessor">#include</span> <span class="org-string">"opencv2/core.hpp"</span>
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;opencv2/imgcodecs.hpp&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;opencv2/highgui.hpp&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string">"Log.h"</span>
<span class="org-preprocessor">#include</span> <span class="org-string">"Misc/Paths.h"</span>
<span class="org-preprocessor">#include</span> <span class="org-string">"TestActor.generated.h"</span>
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2022-06-26 Sun 00:00</p>
<p class="creator"><a href="https://www.gnu.org/software/emacs/">Emacs</a> 29.3 (<a href="https://orgmode.org">Org</a> mode 9.6.15)</p>
</div>
</body>
</html>
